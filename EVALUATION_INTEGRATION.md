# 自动驾驶评估指标集成说明

## 概述

本文档描述了如何在 `carla_sim_llm.py` 中集成和使用 `evaluation_metrics.py` 评估系统，以在路线完成后生成详细的驾驶性能报告。

## 集成功能

### 1. 自动数据收集
系统会在仿真过程中自动收集以下数据：

- **轨迹跟踪指标**：横向偏差、航向偏差、速度偏差
- **安全性指标**：碰撞检测、交通灯违规、与物体距离
- **效率性指标**：速度、加速度、行驶距离和时间
- **舒适性指标**：横向加速度、转向角度和变化率
- **感知性能**：目标检测、车道检测、交通灯检测准确率
- **决策性能**：决策时间统计

### 2. 实时指标更新
每帧仿真都会更新相应的评估指标，包括：
- 车辆状态信息（速度、加速度、位置）
- 控制输入（转向、油门、刹车）
- 感知结果（检测到的物体、车道线）
- 安全事件（交通灯状态、违规行为）

### 3. 完整评估报告
在路线完成时生成包含以下内容的详细报告：

```
🚗 自动驾驶性能评估报告
============================================================
🏆 总体评分: XX.X/100
📈 评级: 优秀/良好/及格/需改进

🛣️ 轨迹跟踪性能:
   • 平均横向偏差: X.XXXm
   • 最大横向偏差: X.XXXm
   • 平均航向偏差: X.XXXrad (XX.X°)
   • 平均速度偏差: X.XXm/s

🛡️ 安全性能:
   • 碰撞次数: X
   • 差点碰撞次数: X
   • 交通灯违规: X
   • 与物体最小距离: X.XXm
   • 平均安全距离: X.XXm

⚡ 效率性能:
   • 平均速度: X.XXm/s (XX.Xkm/h)
   • 最高速度: X.XXm/s (XX.Xkm/h)
   • 平均加速度: X.XXm/s²
   • 平均加速度变化率: X.XXm/s³
   • 总行驶距离: XXX.Xm
   • 总行驶时间: XXX.Xs
   • 路线完成率: XXX.X%

😌 舒适性能:
   • 平均横向加速度: X.XXm/s²
   • 最大横向加速度: X.XXm/s²
   • 平均转向角度: X.XXXrad (XX.X°)
   • 平均转向速率: X.XXXrad/s

👁️ 感知性能:
   • 目标检测准确率: XX.X%
   • 车道检测准确率: XX.X%
   • 交通灯检测准确率: XX.X%

🧠 决策性能:
   • 平均决策时间: XX.Xms
   • 最大决策时间: XX.Xms

💡 改进建议:
   • 根据表现自动生成具体改进建议
```

## 使用方法

### 1. 运行仿真
正常运行CARLA仿真：
```bash
python carla_sim_llm.py --fps 10 --map 1
```

### 2. 评估报告生成
当车辆完成路线（回到起点附近20米范围内）时，系统会自动：
- 停止仿真
- 计算所有评估指标
- 生成并打印详细的评估报告
- 提供改进建议

### 3. 评分系统
- **总分范围**：0-100分
- **评级标准**：
  - 90-100分：优秀 🥇
  - 80-89分：良好 🥈  
  - 70-79分：及格 🥉
  - <70分：需改进 ⚠️

### 4. 权重分配
- 安全性：40%（最高权重）
- 轨迹跟踪：20%
- 效率性：20%
- 舒适性：10%
- 感知性能：5%
- 决策性能：5%

## 自定义配置

### 修改评估窗口大小
在初始化时可以调整滑动窗口大小：
```python
eval_metrics = EvaluationMetrics(window_size=200)  # 默认100
```

### 调整评分权重
可以在 `evaluation_metrics.py` 的 `get_overall_score()` 方法中修改权重：
```python
weights = {
    'safety': 0.5,      # 增加安全性权重
    'trajectory': 0.25, # 增加轨迹跟踪权重
    'efficiency': 0.15,
    'comfort': 0.05,
    'perception': 0.03,
    'decision': 0.02,
}
```

## 注意事项

1. **碰撞检测**：目前使用简单的距离估算，实际应用中需要集成真实的碰撞传感器
2. **感知准确率**：目前使用模拟数值，实际应用中需要与真值进行比较
3. **决策时间**：目前使用固定值，实际应用中需要测量真实的处理时间
4. **路线完成判断**：基于车辆回到起点20米范围内判断完成

## 扩展功能

系统支持进一步扩展：
- 添加更多评估指标
- 集成真实传感器数据
- 导出评估报告到文件
- 添加可视化图表
- 对比多次运行结果

## 日志输出

评估系统会在控制台输出：
- 📊 评估指标系统初始化确认
- 🏁 路线完成通知
- 📊 详细的评估报告
- 💡 基于表现的改进建议
- 🎯 评估完成确认 